<!DOCTYPE html>
<html>
<head>
    <title>Результат загрузки</title>
    <link rel="stylesheet" type="text/css" href="/static/css/table.css">
</head>
<body>
<img class="top" src="/static/img/topImage.png">


    <div class="topBar">

        <div class="centerTopBar">
<p class="topBarTitle">АЙФОН</p>
        <ul class="top">
        <li class="left"><a href="{{ url_for('home') }}">Главная</a></li>
        <li class="left"><a href="{{ url_for('result') }}">Полный список</a></li>
        <li class="left"><a href="{{ url_for('result_pm') }}">ПМ</a></li>
        <li class="selected"><a href="{{ url_for('result_ivt') }}">ИВТ</a></li>
        <li class="left"><a href="{{ url_for('result_itss') }}">ИТСС</a></li>
        <li class="left"><a href="{{ url_for('result_ib') }}">ИБ</a></li>
            </ul>
            <img class="logo" src="/static/img/logo.jpg">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('generate_report') }}">
                Сформировать отчет (PDF)
            </a>

                    <a class="logout-btn" href="{{ url_for('logout') }}">Выйти</a>
                {% else %}
                    <a class="login-btn" href="{{ url_for('login') }}">Войти</a>
                {% endif %}


        </div>
        <div>
            {% if current_user.is_authenticated %}
                <li class="left"><form method="POST" action="/upload" enctype="multipart/form-data">
    <input type="file" name="file">
    <input type="submit" value="Загрузить список">
                </form></li>
            {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
            {% endwith %}
            {% endif %}
        </div>
    </div>
<div class="return">
    <a href="{{ url_for('home') }}">Назад</a>
</div>
<div class="current-day-info">
    <h3>День: {{ current_day }}</h3>
</div>
    {% if count %}

    <div class="aboveTable">
        <div class="filters">
        <div class="filter-group">
            <label>Фильтр по согласию:</label>
            <select id="consentFilter">
                <option value="all">Все абитуриенты</option>
                <option value="true">Только с согласием</option>
                <option value="false">Только без согласия</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Сортировка по сумме баллов:</label>
            <ul class="filters">
            <li><button onclick="sortBySum('desc')">По убыванию</button></li>
            <li><button onclick="sortBySum('asc')">По возрастанию</button></li>
            </ul>
        </div>

            <button class="sortApply" onclick="applyFilters()">Применить фильтры</button>
            <button onclick="resetFilters()" class="sortReset">Сбросить фильтры</button>

    </div>
        <div>
    <h2 class="summary">Всего абитуриентов: {{ count }}</h2>
    <h2 class="summary">Абитуриенты с согласиями: {{ consent_count }}</h2>
    <h2 class="summary">Зачисленные абитуриенты: {{ enrolled_count }}/50</h2>
            {% if passing_score == 0 %}
                <h2 class="summary"> НЕДОБОР </h2>
            {% else %}
                <h2 class="summary">Проходной балл: {{ passing_score }} </h2>
            {% endif %}
        </div>

    </div>
<h1 class="center">Загруженная таблица</h1>
    <div class="table">
        {{ table | safe }}
    </div>
<script>
       let originalRows = null;
let currentConsentFilter = 'all';
let currentSortDirection = 'desc';

document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    if (table) {
        originalRows = Array.from(table.rows).map(row => row.cloneNode(true));
    }

    setTimeout(() => {
        applyFilters();
    }, 100);
});

function applyFilters() {
    currentConsentFilter = document.getElementById('consentFilter').value;
    const table = document.querySelector('table');
    let consentColumnIndex = -1;
    let sumColumnIndex = -1;
    const headerCells = originalRows[0].cells;

    for (let i = 0; i < headerCells.length; i++) {
        const cellText = headerCells[i].textContent.trim();
        if (cellText === 'Согласие') {
            consentColumnIndex = i;
        }
        if (cellText === 'Сумма') {
            sumColumnIndex = i;
        }
    }
    let visibleRows = [];

    for (let i = 1; i < originalRows.length; i++) {
        const row = originalRows[i];
        const cells = row.cells;
        if (cells.length <= consentColumnIndex) continue;
        let showRow = true;
        if (currentConsentFilter !== 'all' && consentColumnIndex !== -1) {
            const consentCell = cells[consentColumnIndex];
            if (consentCell) {
                const consentText = consentCell.textContent.trim();
                const hasConsent = consentText === 'Есть';
                if (currentConsentFilter === 'true') {
                    showRow = hasConsent;
                } else if (currentConsentFilter === 'false') {
                    showRow = !hasConsent;
                }
            }
        }
        if (showRow) {
            let sumValue = 0;
            if (sumColumnIndex !== -1) {
                const sumCell = cells[sumColumnIndex];
                if (sumCell) {
                    sumValue = parseInt(sumCell.textContent.trim()) || 0;
                }
            }
            visibleRows.push({
                row: row.cloneNode(true),
                sum: sumValue,
                hasConsent: consentColumnIndex !== -1 ?
                    cells[consentColumnIndex].textContent.trim() === 'Есть' : false
            });
        }
    }
    if (currentSortDirection) {
        visibleRows.sort((a, b) => {
            if (currentSortDirection === 'desc') {
                return b.sum - a.sum;
            } else {
                return a.sum - b.sum;
            }
        });
    }
    updateTable(visibleRows);
    updateTableHeader();
}

function sortBySum(direction) {
    currentSortDirection = direction;
    applyFilters();
}

function updateTable(visibleRows) {
    const table = document.querySelector('table');
    if (!table) return;
    const headerRow = originalRows[0].cloneNode(true);
    while (table.firstChild) {
        table.removeChild(table.firstChild);
    }
    table.appendChild(headerRow);

    visibleRows.forEach(item => {
        table.appendChild(item.row);
    });
}

function updateTableHeader() {
    const table = document.querySelector('table');
    if (!table) return;
    const totalRows = table.rows.length - 1;
    let filterText = '';
    if (currentConsentFilter === 'true') {
        filterText = ' (только с согласием)';
    } else if (currentConsentFilter === 'false') {
        filterText = ' (только без согласия)';
    }
    let sortText = '';
    if (currentSortDirection === 'desc') {
        sortText = ' - отсортировано по убыванию суммы';
    } else if (currentSortDirection === 'asc') {
        sortText = ' - отсортировано по возрастанию суммы';
    }
    const h1 = document.querySelector('.table h1');
    if (h1) {
        h1.textContent = `Таблица абитуриентов${filterText}${sortText} (показано: ${totalRows})`;
    }
    const summaryElement = document.querySelector('.summary');
    if (summaryElement) {
        summaryElement.textContent = `Всего абитуриентов: ${totalRows}`;
    }
}

function resetFilters() {
    document.getElementById('consentFilter').value = 'all';
    currentConsentFilter = 'all';
    currentSortDirection = 'desc';

    applyFilters();
}
    </script>
{% else %}
<h1 class="noData">Список ещё не загружен</h1>
{% endif %}
</body>
</html>



